---
# Self-updating Ansible installation using uv
# Bootstrap: run first-time-install-ansible.sh to create venv with uv + ansible
# This task keeps the installation updated using the same uv tooling
# Default venv: ~/.ansible-venv (override with ansible_venv_path)

- name: devops | ansible | ensure venv exists
  ansible.builtin.command:
    cmd: "uv venv {{ ansible_venv_path }}"
    creates: "{{ ansible_venv_path }}/bin/activate"
  tags:
    - devops
    - ansible

- name: devops | ansible | get installed version
  ansible.builtin.shell:
    cmd: >-
      uv pip show
      --python {{ ansible_venv_path }}/bin/python
      ansible 2>/dev/null
      | awk '/^Version:/{print $2}'
  register: reg_ansible_version
  failed_when: false
  changed_when: false
  tags:
    - devops
    - ansible

- name: devops | ansible | set version facts
  ansible.builtin.set_fact:
    ansible_version_instalada: "{{ reg_ansible_version.stdout | default('') }}"
  tags:
    - devops
    - ansible

- ansible.builtin.debug:
    msg: "Ansible installed version  - {{ ansible_version_instalada | default('none') }}"
  tags:
    - devops
    - ansible

- ansible.builtin.debug:
    msg: "Ansible desired version    - {{ ansible_version_deseada | d('latest') }}"
  tags:
    - devops
    - ansible

- name: devops | ansible | install specific ansible version
  ansible.builtin.command:
    cmd: >-
      uv pip install
      --python {{ ansible_venv_path }}/bin/python
      ansible=={{ ansible_version_deseada }} ansible-lint
  when:
    - ansible_version_deseada | d('') != ''
    - ansible_version_instalada != ansible_version_deseada
  tags:
    - devops
    - ansible

- name: devops | ansible | update ansible to latest
  ansible.builtin.command:
    cmd: >-
      uv pip install --upgrade
      --python {{ ansible_venv_path }}/bin/python
      ansible ansible-lint
  register: reg_ansible_upgrade
  changed_when: reg_ansible_upgrade.stdout is search('Installed|Uninstalled')
  when: ansible_version_deseada | d('') == ''
  tags:
    - devops
    - ansible

- name: devops | ansible | install optional ansible-cmdb
  ansible.builtin.command:
    cmd: >-
      uv pip install --upgrade
      --python {{ ansible_venv_path }}/bin/python
      ansible-cmdb
  register: reg_ansible_cmdb
  changed_when: reg_ansible_cmdb.stdout is search('Installed|Uninstalled')
  when: install_ansible_cmdb | default(false) | bool
  tags:
    - devops
    - ansible

- name: devops | ansible | install optional proxmoxer
  ansible.builtin.command:
    cmd: >-
      uv pip install --upgrade
      --python {{ ansible_venv_path }}/bin/python
      proxmoxer
  register: reg_proxmoxer
  changed_when: reg_proxmoxer.stdout is search('Installed|Uninstalled')
  when: install_proxmoxer | default(false) | bool
  tags:
    - devops
    - ansible
